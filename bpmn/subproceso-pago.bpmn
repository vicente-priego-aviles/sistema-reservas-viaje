<?xml version="1.0" encoding="UTF-8"?>
<bpmn:definitions xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL" xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" xmlns:dc="http://www.omg.org/spec/DD/20100524/DC" xmlns:di="http://www.omg.org/spec/DD/20100524/DI" xmlns:zeebe="http://camunda.org/schema/zeebe/1.0" xmlns:modeler="http://camunda.org/schema/modeler/1.0" id="Definitions_ProcesoPago" targetNamespace="http://bpmn.io/schema/bpmn" exporter="Camunda Modeler" exporterVersion="5.37.0" modeler:executionPlatform="Camunda Cloud" modeler:executionPlatformVersion="8.7.0">
  <bpmn:process id="subproceso-pago" name="Proceso de Pago" isExecutable="true">
    <bpmn:serviceTask id="actualizar-estado-confirmado" name="Actualizar Estado: Confirmado">
      <bpmn:extensionElements>
        <zeebe:taskDefinition type="actualizar-estado-cliente" />
        <zeebe:ioMapping>
          <zeebe:input source="=&#34;RESERVA_CONFIRMADA&#34;" target="nuevoEstado" />
          <zeebe:input source="=reservaId" target="reservaIdConfirmada" />
        </zeebe:ioMapping>
      </bpmn:extensionElements>
      <bpmn:incoming>flujo-pago-a-actualizar-estado-confirmado</bpmn:incoming>
      <bpmn:outgoing>flujo-pago-a-reserva-exitosa</bpmn:outgoing>
    </bpmn:serviceTask>
    <bpmn:intermediateThrowEvent id="evento-compensar-reserva" name="Compensar Reserva">
      <bpmn:extensionElements>
        <zeebe:taskDefinition type="" />
      </bpmn:extensionElements>
      <bpmn:incoming>flujo-pago-desde-error-pago</bpmn:incoming>
      <bpmn:outgoing>flujo-pago-a-notificar-tarjeta-invalida</bpmn:outgoing>
      <bpmn:messageEventDefinition id="MessageEventDef_CompensarReserva" />
    </bpmn:intermediateThrowEvent>
    <bpmn:serviceTask id="confirmar-reserva-completa" name="Confirmar Reserva Completa">
      <bpmn:extensionElements>
        <zeebe:taskDefinition type="confirmar-reserva" />
      </bpmn:extensionElements>
      <bpmn:incoming>flujo-pago-a-confirmar-reserva</bpmn:incoming>
      <bpmn:outgoing>flujo-pago-a-actualizar-estado-confirmado</bpmn:outgoing>
    </bpmn:serviceTask>
    <bpmn:boundaryEvent id="evento-error-actualizacion" name="Error Actualización Cliente" attachedToRef="actualizar-estado-confirmado">
      <bpmn:outgoing>flujo-pago-desde-error-actualizacion</bpmn:outgoing>
      <bpmn:errorEventDefinition id="ErrorEventDef_ActualizacionCliente" errorRef="Error_ActualizacionCliente" />
    </bpmn:boundaryEvent>
    <bpmn:boundaryEvent id="evento-error-pago" name="Error Procesar Pago" attachedToRef="procesar-pago">
      <bpmn:outgoing>flujo-pago-desde-error-pago</bpmn:outgoing>
      <bpmn:errorEventDefinition id="ErrorEventDef_ErrorPago" errorRef="Error_ProcesarPago" />
    </bpmn:boundaryEvent>
    <bpmn:sequenceFlow id="flujo-pago-a-actualizar-estado-confirmado" sourceRef="confirmar-reserva-completa" targetRef="actualizar-estado-confirmado" />
    <bpmn:sequenceFlow id="flujo-pago-a-confirmar-reserva" sourceRef="procesar-pago" targetRef="confirmar-reserva-completa" />
    <bpmn:sequenceFlow id="flujo-pago-a-fin-con-advertencia" sourceRef="marcar-reserva-advertencia" targetRef="fin-reserva-con-advertencia" />
    <bpmn:sequenceFlow id="flujo-pago-a-marcar-advertencia" sourceRef="revertir-estado-cliente" targetRef="marcar-reserva-advertencia" />
    <bpmn:sequenceFlow id="flujo-pago-a-notificar-tarjeta-invalida" sourceRef="evento-compensar-reserva" targetRef="notificar-tarjeta-invalida" />
    <bpmn:sequenceFlow id="flujo-pago-a-procesar" sourceRef="pago-inicio" targetRef="procesar-pago" />
    <bpmn:sequenceFlow id="flujo-pago-a-reserva-exitosa" sourceRef="actualizar-estado-confirmado" targetRef="fin-reserva-exitosa" />
    <bpmn:sequenceFlow id="flujo-pago-a-reserva-no-completada" sourceRef="notificar-tarjeta-invalida" targetRef="fin-reserva-no-completada" />
    <bpmn:sequenceFlow id="flujo-pago-desde-error-actualizacion" sourceRef="evento-error-actualizacion" targetRef="revertir-estado-cliente" />
    <bpmn:sequenceFlow id="flujo-pago-desde-error-pago" sourceRef="evento-error-pago" targetRef="evento-compensar-reserva" />
    <bpmn:startEvent id="pago-inicio" name="Iniciar Proceso de Pago">
      <bpmn:outgoing>flujo-pago-a-procesar</bpmn:outgoing>
    </bpmn:startEvent>
    <bpmn:serviceTask id="marcar-reserva-advertencia" name="Marcar Reserva con Advertencia">
      <bpmn:extensionElements>
        <zeebe:taskDefinition type="marcar-reserva-advertencia" />
        <zeebe:ioMapping>
          <zeebe:input source="=&#34;CONFIRMADA_CON_ADVERTENCIA&#34;" target="estadoReservaFinal" />
          <zeebe:input source="=true" target="requiereIntervencionManual" />
        </zeebe:ioMapping>
      </bpmn:extensionElements>
      <bpmn:incoming>flujo-pago-a-marcar-advertencia</bpmn:incoming>
      <bpmn:outgoing>flujo-pago-a-fin-con-advertencia</bpmn:outgoing>
    </bpmn:serviceTask>
    <bpmn:sendTask id="notificar-tarjeta-invalida" name="Notificar Cliente Tarjeta Crédito No Válida">
      <bpmn:extensionElements>
        <zeebe:taskDefinition type="notifyInvalidCreditCard" />
      </bpmn:extensionElements>
      <bpmn:incoming>flujo-pago-a-notificar-tarjeta-invalida</bpmn:incoming>
      <bpmn:outgoing>flujo-pago-a-reserva-no-completada</bpmn:outgoing>
    </bpmn:sendTask>
    <bpmn:serviceTask id="procesar-pago" name="Procesar Pago">
      <bpmn:extensionElements>
        <zeebe:taskDefinition type="procesar-pago" retries="3" />
      </bpmn:extensionElements>
      <bpmn:incoming>flujo-pago-a-procesar</bpmn:incoming>
      <bpmn:outgoing>flujo-pago-a-confirmar-reserva</bpmn:outgoing>
    </bpmn:serviceTask>
    <bpmn:endEvent id="fin-reserva-con-advertencia" name="Reserva Confirmada con Advertencia">
      <bpmn:incoming>flujo-pago-a-fin-con-advertencia</bpmn:incoming>
    </bpmn:endEvent>
    <bpmn:endEvent id="fin-reserva-no-completada" name="Reserva No Completada">
      <bpmn:incoming>flujo-pago-a-reserva-no-completada</bpmn:incoming>
    </bpmn:endEvent>
    <bpmn:serviceTask id="revertir-estado-cliente" name="Revertir Estado del Cliente">
      <bpmn:extensionElements>
        <zeebe:taskDefinition type="revertir-estado-cliente" />
        <zeebe:ioMapping>
          <zeebe:input source="=&#34;ACTIVO&#34;" target="nuevoEstado" />
          <zeebe:input source="=&#34;Error al actualizar estado tras confirmación&#34;" target="motivoReversion" />
        </zeebe:ioMapping>
      </bpmn:extensionElements>
      <bpmn:incoming>flujo-pago-desde-error-actualizacion</bpmn:incoming>
      <bpmn:outgoing>flujo-pago-a-marcar-advertencia</bpmn:outgoing>
    </bpmn:serviceTask>
    <bpmn:endEvent id="fin-reserva-exitosa" name="Viaje Reservado con Éxito">
      <bpmn:incoming>flujo-pago-a-reserva-exitosa</bpmn:incoming>
    </bpmn:endEvent>
  </bpmn:process>
  <bpmn:error id="Error_ProcesarPago" name="Error Procesar Pago" errorCode="ERROR_PROCESAR_PAGO" />
  <bpmn:error id="Error_ActualizacionCliente" name="Error Actualización Cliente Fallida" errorCode="ERROR_ACTUALIZACION_CLIENTE" />
  <bpmndi:BPMNDiagram id="BPMNDiagram_ProcesoPago">
    <bpmndi:BPMNPlane id="BPMNPlane_ProcesoPago" bpmnElement="subproceso-pago">
      <bpmndi:BPMNShape id="Shape_pago-inicio" bpmnElement="pago-inicio">
        <dc:Bounds x="152" y="272" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="133" y="315" width="74" height="27" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Shape_procesar-pago" bpmnElement="procesar-pago">
        <dc:Bounds x="240" y="250" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Shape_confirmar-reserva-completa" bpmnElement="confirmar-reserva-completa">
        <dc:Bounds x="390" y="250" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Shape_actualizar-estado-confirmado" bpmnElement="actualizar-estado-confirmado">
        <dc:Bounds x="540" y="250" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Shape_fin-reserva-exitosa" bpmnElement="fin-reserva-exitosa">
        <dc:Bounds x="692" y="272" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="670" y="311" width="81" height="27" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Shape_evento-compensar-reserva" bpmnElement="evento-compensar-reserva">
        <dc:Bounds x="272" y="392" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="262" y="435" width="58" height="27" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Shape_revertir-estado-cliente" bpmnElement="revertir-estado-cliente">
        <dc:Bounds x="620" y="85" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Shape_marcar-reserva-advertencia" bpmnElement="marcar-reserva-advertencia">
        <dc:Bounds x="760" y="85" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Shape_fin-reserva-con-advertencia" bpmnElement="fin-reserva-con-advertencia">
        <dc:Bounds x="912" y="107" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="891" y="145" width="78" height="40" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Shape_notificar-tarjeta-invalida" bpmnElement="notificar-tarjeta-invalida">
        <dc:Bounds x="390" y="370" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Shape_fin-reserva-no-completada" bpmnElement="fin-reserva-no-completada">
        <dc:Bounds x="572" y="392" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="561" y="435" width="61" height="27" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Shape_evento-error-actualizacion" bpmnElement="evento-error-actualizacion">
        <dc:Bounds x="572" y="232" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="617" y="207" width="65" height="40" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Shape_evento-error-pago" bpmnElement="evento-error-pago">
        <dc:Bounds x="272" y="312" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="206" y="350" width="72" height="27" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge id="Edge_flujo-pago-a-procesar" bpmnElement="flujo-pago-a-procesar">
        <di:waypoint x="188" y="290" />
        <di:waypoint x="240" y="290" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Edge_flujo-pago-a-confirmar-reserva" bpmnElement="flujo-pago-a-confirmar-reserva">
        <di:waypoint x="340" y="290" />
        <di:waypoint x="390" y="290" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Edge_flujo-pago-a-actualizar-estado-confirmado" bpmnElement="flujo-pago-a-actualizar-estado-confirmado">
        <di:waypoint x="490" y="290" />
        <di:waypoint x="540" y="290" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Edge_flujo-pago-a-reserva-exitosa" bpmnElement="flujo-pago-a-reserva-exitosa">
        <di:waypoint x="640" y="290" />
        <di:waypoint x="692" y="290" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Edge_flujo-pago-desde-error-pago" bpmnElement="flujo-pago-desde-error-pago">
        <di:waypoint x="290" y="348" />
        <di:waypoint x="290" y="392" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Edge_flujo-pago-a-notificar-tarjeta-invalida" bpmnElement="flujo-pago-a-notificar-tarjeta-invalida">
        <di:waypoint x="308" y="410" />
        <di:waypoint x="390" y="410" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Edge_flujo-pago-a-reserva-no-completada" bpmnElement="flujo-pago-a-reserva-no-completada">
        <di:waypoint x="490" y="410" />
        <di:waypoint x="572" y="410" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Edge_flujo-pago-desde-error-actualizacion" bpmnElement="flujo-pago-desde-error-actualizacion">
        <di:waypoint x="590" y="232" />
        <di:waypoint x="590" y="125" />
        <di:waypoint x="620" y="125" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Edge_flujo-pago-a-marcar-advertencia" bpmnElement="flujo-pago-a-marcar-advertencia">
        <di:waypoint x="720" y="125" />
        <di:waypoint x="760" y="125" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Edge_flujo-pago-a-fin-con-advertencia" bpmnElement="flujo-pago-a-fin-con-advertencia">
        <di:waypoint x="860" y="125" />
        <di:waypoint x="912" y="125" />
      </bpmndi:BPMNEdge>
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
</bpmn:definitions>
